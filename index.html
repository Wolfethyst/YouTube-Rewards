<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>YouTube Rewards Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,Helvetica,sans-serif;background:#111;color:#eee;margin:0;padding:2rem;}
  .card{background:#222;padding:1.5rem;border-radius:8px;margin-bottom:1rem;max-width:400px;}
  .title{font-size:1.4rem;margin-bottom:.5rem;}
  .pts{font-size:1.2rem;color:#9f6cff;margin-bottom:.5rem;}
  button{background:#9f6cff;color:#111;padding:.6rem 1rem;border:none;border-radius:4px;cursor:pointer;}
  button:disabled{background:#555;cursor:not-allowed;}
</style>
</head>

<body>

<h1>YouTube Rewards Hub</h1>

<div id="status">ðŸ”Ž Detecting youâ€¦</div>

<div id="hub" style="display:none;">
  <div class="card">
    <div class="title">Your Points</div>
    <div class="pts" id="points">â€”</div>
  </div>

  <div class="card">
    <div class="title">Choose a Reward</div>
    <button data-reward="tts">ðŸ’¬ TTS (100â€¯pts)</button>
    <button data-reward="shoutout">ðŸ“£ Shoutâ€‘out (250â€¯pts)</button>
    <!-- add more buttons as you define new rewards -->
  </div>
</div>

<script>
/* -------------------------------------------------------------
   â˜…â˜…â˜…â˜…â˜…  SHARED SECRET TOKEN  â˜…â˜…â˜…â˜…â˜…
   ------------------------------------------------------------- */
const SECRET_TOKEN = "c4id3n-7x9-qrty-2bmv";   // <-- keep identical to the token in the Netlify function

/* -------------------------------------------------------------
   Netlify function endpoint (same origin, no CORS issues)
   ------------------------------------------------------------- */
const REWARD_ENDPOINT = "/api/reward";

/* -------------------------------------------------------------
   Helper â€“ extract ?yt=CHANNEL_ID from the URL
   ------------------------------------------------------------- */
function getViewerId() {
  const p = new URLSearchParams(location.search);
  return p.get('yt');
}

/* ---------- Load current points (GET) ---------- */
async function loadPoints(ytId) {
  const url = `${REWARD_ENDPOINT}?yt=${encodeURIComponent(ytId)}&action=getPoints&token=${encodeURIComponent(SECRET_TOKEN)}`;
  const r   = await fetch(url);
  const d   = await r.json();
  document.getElementById('points').textContent = d.points ?? 0;
}

/* ---------- Claim a reward (POST) ---------- */
async function claimReward(ytId, rewardId) {
  const payload = {
    ytId,
    rewardId,
    token: SECRET_TOKEN
  };

  const r = await fetch(REWARD_ENDPOINT, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });

  const d = await r.json();
  if (d.success) {
    alert(`âœ… Reward claimed! Remaining points: ${d.remaining}`);
    loadPoints(ytId);               // refresh displayed balance
  } else {
    alert(`âŒ ${d.error ?? 'Unknown error'}`);
  }
}

/* ---------- Initialise page ---------- */
(async () => {
  const ytId = getViewerId();
  if (!ytId) {
    document.getElementById('status').textContent =
      'âš ï¸ No YouTube ID supplied. Append "?yt=YOUR_CHANNEL_ID" to the URL.';
    return;
  }
  document.getElementById('status').style.display = 'none';
  document.getElementById('hub').style.display = 'block';

  await loadPoints(ytId);

  // Wire up the buttons
  document.querySelectorAll('button[data-reward]').forEach(btn => {
    btn.addEventListener('click', () => claimReward(ytId, btn.dataset.reward));
  });
})();
</script>
</body>
</html>